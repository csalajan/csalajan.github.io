var HashTable=function(){this.type="HashTable",this.table=new Array};HashTable.prototype.BetterHash=function(t){const e=37;for(var i=0,s=0;s<t.length;++s)i+=e*i+t.charCodeAt(s);return hash=i%this.table.length,hash<0&&(hash+=this.table.length-1),parseInt(hash)},HashTable.prototype.Put=function(t){var e=t.grid.x*Math.pow(2,6)+t.grid.y;this.table[e]=t},HashTable.prototype.Get=function(t,e){var i=t*Math.pow(2,6)+e;return this.table[i]};var FogOfWar=function(t){this.fogCanvas=document.getElementById("FogOfWar"),this.fogContext=this.fogCanvas.getContext("2d"),this.canvasWidth=t.canvas.width,this.canvasHeight=t.canvas.height,this.radius=50};FogOfWar.prototype.Init=function(){this.fogContext=this.fogCanvas.getContext("2d"),this.fogContext.fillStyle="rgba(0,0,0,1)",this.fogContext.fillRect(0,0,this.canvasWidth,this.canvasHeight)},FogOfWar.prototype.Reveal=function(t){this.fogContext.clearRect(t.x-this.radius,t.y-this.radius,2*this.radius,2*this.radius)};var GameObject={Clear:function(t){t.clearRect(this.center.x-this.size.x/2,this.center.y-this.size.y/2,this.size.x,this.size.y)},Update:function(){},Draw:function(t){t.fillStyle=this.color,t.fillRect(this.center.x-this.size.x/2,this.center.y-this.size.y/2,this.size.x,this.size.y)},collisions:{191:"wall",127:"wall",128:"wall",573:"wall",369:"wall",254:"wall",493:"enemy",382:"bullet"},CheckCollision:function(t){var e=this.game.context.getImageData(t.x-this.size.x/2,t.y-this.size.y/2,this.size.x,this.size.y),i=this.Pixels(e.data);return 0!=i?this.Collide(this.collisions[i]):!0},Pixels:function(t){var e={},i=t.filter(function(t){return e.hasOwnProperty(t)?!1:e[t]=!0}).filter(function(t){return 0!=t});return i.length>0?i.reduce(function(t,e){return t+e},0):i},Collide:function(t){},GridPos:function(){var t=Math.floor(this.center.x/(this.game.Level.params.width*this.game.Level.params.scale)*this.game.Level.params.width),e=Math.floor(this.center.y/(this.game.Level.params.height*this.game.Level.params.scale)*this.game.Level.params.height);return this.game.Level.grid.Get(t,e)}},Keyboarder=function(){var t={},e=!1;window.onkeydown=function(e){t[e.keyCode]=!0},window.onkeyup=function(i){t[i.keyCode]=!1,e=!1},this.isDown=function(e){return t[e]===!0},this.isDownOnce=function(i){return t[i]&&!e?(e=!0,!0):!1},this.KEYS={UP:38,DOWN:40,LEFT:37,RIGHT:39,SPACE:32}},PCEngine=function(t){this.game=t};PCEngine.prototype.GenerateStuff=function(){setInterval(function(){this.game.bodies.push(new Block)}.bind(this),1e3)},PCEngine.prototype.MazeGenerator=function(t){var e=new Maze(t);e.Build(),e.Draw(this.game.context)};var Scene={Start:function(){}},Timer=function(){this.ele=document.getElementById("Timer"),this.timer,this.startTime,this.elapsed,this.last=(new Date).getTime()};Timer.prototype.Start=function(){this.startTime=(new Date).getTime(),this.timer=setInterval(function(){var t=(new Date).getTime()-this.startTime;this.elapsed=Math.floor(t/100)/10,this.ele.innerHTML=this.elapsed}.bind(this),100)},Timer.prototype.Stop=function(){clearInterval(this.timer)},Timer.prototype.Last=function(){this.last=(new Date).getTime()},Timer.prototype.Delta=function(){return(new Date).getTime()-this.last};var Block=function(){this.center={x:600,y:600},this.size={x:10,y:10}};Block.prototype.Update=function(){this.center.x-=2},Block.prototype.Draw=function(t){t.fillRect(this.center.x-this.size.x/2,this.center.y-this.size.y/2,this.size.x,this.size.y)};var Bullet=function(t){switch(this.game=t.game,this.direction=t.facing,this.center=t.center,this.velocity=3,this.collisions[255]="wall",t instanceof Player?this.color="red":this.color="#0022CC",this.direction){case"right":case"left":this.size={x:4,y:2};break;case"up":case"down":this.size={x:2,y:4}}this.move={x:"left"==this.direction?-this.velocity:"right"==this.direction?this.velocity:0,y:"up"==this.direction?-this.velocity:"down"==this.direction?this.velocity:0}};Bullet.prototype=Object.create(GameObject),Bullet.prototype.Update=function(){var t={x:this.center.x+this.move.x,y:this.center.y+this.move.y};this.CheckCollision(t)&&(this.center=t)},Bullet.prototype.Collide=function(t){switch(t){case"enemy":if(this.owner instanceof Enemy)return!0;case"wall":return this.game.Destroy(this),!1;default:return!0}};var Camera=function(t,e,i,s,h,a){this.xView=t||0,this.yView=e||0,this.xDeadZone=0,this.yDeadZone=0,this.wView=i,this.hView=s,this.axis="both",this.followed=null,this.viewportRect=new Rectangle(this.xView,this.yView,this.wView,this.hView),this.worldRect=new Rectangle(0,0,h,a)};Camera.prototype.Follow=function(t,e,i){this.followed=t,this.xDeadZone=e,this.yDeadZone=i},Camera.prototype.Update=function(){null!=this.followed&&(this.followed.center.x-this.xView+this.xDeadZone>this.wView?this.xView=this.followed.center.x-(this.wView-this.xDeadZone):this.followed.center.x-this.xDeadZone<this.xView&&(this.xView=this.followed.center.x-this.xDeadZone),this.followed.center.y-this.yView+this.yDeadZone>this.hView?this.yView=this.followed.center.y-(this.hView-this.yDeadZone):this.followed.center.y-this.yDeadZone<this.yView&&(this.yView=this.followed.center.y-this.yDeadZone),this.viewportRect.set(this.xView,this.yView),this.viewportRect.within(this.worldRect)||(this.viewportRect.left<this.worldRect.left&&(this.xView=this.worldRect.left),this.viewportRect.top<this.worldRect.top&&(this.yView=this.worldRect.top),this.viewportRect.right>this.worldRect.right&&(this.xView=this.worldRect.right-this.wView),this.viewportRect.bottom>this.worldRect.bottom&&(this.yView=this.worldRect.bottom-this.hView)))},Camera.prototype.Draw=function(){},Camera.prototype.Clear=function(){};var Rectangle=function(t,e,i,s){this.left=t||0,this.top=e||0,this.width=i||0,this.height=s||0,this.right=this.left+this.width,this.bottom=this.top+this.height};Rectangle.prototype.set=function(t,e,i,s){this.left=t,this.top=e,this.width=i||this.width,this.height=s||this.height,this.right=this.left+this.width,this.bottom=this.top+this.height},Rectangle.prototype.within=function(t){return t.left<=this.left&&t.right>=this.right&&t.top<=this.top&&t.bottom>=this.bottom},Rectangle.prototype.overlaps=function(t){return this.left<t.right&&t.left<this.right&&this.top<t.bottom&&t.top<this.bottom};var Enemy=function(t){this.game=t,this.color="#0022CC",this.facing="right",this.directions={0:"right",1:"up",2:"left",3:"down"},this.center={x:1,y:1},this.size={x:14,y:14},this.SetStartLocation()};Enemy.prototype=Object.create(GameObject),Enemy.prototype.SetStartLocation=function(){var t=Math.random()*this.game.canvas.width,e=Math.random()*this.game.canvas.height;this.center.x=t-t%this.game.Level.params.scale+this.game.Level.params.scale/2,this.center.y=e-e%this.game.Level.params.scale+this.game.Level.params.scale/2},Enemy.prototype.Update=function(){var t={x:this.center.x,y:this.center.y};switch(this.facing){case"right":t.x+=1;break;case"up":t.y-=1;break;case"left":t.x-=1;break;case"down":t.y+=1}this.CheckCollision(t)?this.center=t:this.facing=this.newDirection(),5==Math.floor(100*Math.random())&&this.game.bodies.push(new Bullet(this))},Enemy.prototype.newDirection=function(t){var e=Math.floor(4*Math.random()),i=this.directions[e];return i==t?this.directions[e++%4]:i},Enemy.prototype.Collide=function(t){switch(t){case"wall":break;case"exit":break;case"enemy":break;case"bullet":this.game.Destroy(this)}};var Exit=function(t){this.game=t,this.color="#00FF00",this.center={x:t.canvas.width-5,y:t.canvas.height-5},this.size={x:6,y:6}};Exit.prototype=Object.create(GameObject),Exit.prototype.Update=function(){this.game.fogOfWar.Reveal(this.center)};var Maze=function(t){this.data=[],this.params=t,this.full=0,this.dir=["up","down","left","right"],this.oDir={up:"down",down:"up",left:"right",right:"left"},this.size=this.params.height*this.params.width};Maze.prototype.Build=function(){for(var t=0;t<this.params.width;t++){this.data[t]=[];for(var e=0;e<this.params.height;e++)this.data[t][e]=new Wall(this.params,t,e)}var t=this.rand(this.params.width),e=this.rand(this.params.height),i=this.dir[this.rand(4)];this.DoMaze(t,e,i)},Maze.prototype.rand=function(t){return Math.floor(t*Math.random())},Maze.prototype.DoMaze=function(t,e,i){this.full++;this.full/this.size;this.data[t][e].visited=!0;var s=i;if(!(Math.random()<this.params.deadEnd)){Math.random()<this.params.turn&&("up"==i||"down"==i?s=Math.random()<.5?"left":"right":("left"==i||"right"==i)&&(s=Math.random()<.5?"up":"down"));var h=0,a=0;switch(s){case"up":a=-1;break;case"down":a=1;break;case"left":h=-1;break;case"right":h=1}if(this.MazeVisited(t+h,e+a))if(Math.random()<this.params.reconnect&&this.MazeInBounds(t+h,e+a))this.data[t][e][s]=!0,this.data[t+h][e+a][this.oDir[s]]=!0;else{for(var o=[],r=0;4>r;r++)this.dir[r]!=s&&this.dir[r]!=this.oDir[i]&&o.push(this.dir[r]);if(Math.random()<.5){var n=o[0];o[0]=o[1],o[1]=n}for(l=0;2>l;l++){var h=0,a=0,c=o[l];switch(c){case"up":a=-1;break;case"down":a=1;break;case"left":h=-1;break;case"right":h=1}this.MazeVisited(t+h,e+a)||(this.data[t][e][c]=!0,this.data[t+h][e+a][this.oDir[c]]=!0,this.DoMaze(t+h,e+a,c))}}else this.data[t][e][s]=!0,this.data[t+h][e+a][this.oDir[s]]=!0,this.DoMaze(t+h,e+a,s);for(var l=0;4>l;l++)if(Math.random()<this.params.branch){var h=0,a=0;switch(c=this.dir[l]){case"up":a=-1;break;case"down":a=1;break;case"left":h=-1;break;case"right":h=1}this.MazeVisited(t+h,e+a)||(this.data[t][e][c]=!0,this.data[t+h][e+a][this.oDir[c]]=!0,this.DoMaze(t+h,e+a,c))}}},Maze.prototype.MazeVisited=function(t,e){return this.MazeInBounds(t,e)?this.data[t][e].visited:!0},Maze.prototype.MazeInBounds=function(t,e){return!(0>t||t>=this.params.width||0>e||e>=this.params.height)},Maze.prototype.Draw=function(t,e){for(var i=0;i<this.params.width;i++)for(var s=0;s<this.params.height;s++)this.data[i][s].Draw(t),e.grid.Put(this.data[i][s])};var Player=function(t){this.game=t,this.color="#FF0000",this.facing="right",this.elex=document.getElementById("x"),this.eley=document.getElementById("y"),this.center={x:8,y:8},this.size={x:14,y:14},this.speed=16,this.keyboarder=new Keyboarder,setInterval(function(){this.PrintPosition()}.bind(this),1e3)};Player.prototype=Object.create(GameObject),Player.prototype.PrintPosition=function(){var t=this.GridPos();this.elex.innerHTML=t.grid.x,this.eley.innerHTML=t.grid.y},Player.prototype.Update=function(){var t={x:this.center.x,y:this.center.y},e=this.GridPos();this.keyboarder.isDown(this.keyboarder.KEYS.UP)&&e.up?(t.y=this.center.y-this.speed,this.facing="up"):this.keyboarder.isDown(this.keyboarder.KEYS.DOWN)&&e.down?(t.y=this.center.y+this.speed,this.facing="down"):this.keyboarder.isDown(this.keyboarder.KEYS.LEFT)&&e.left?(t.x=this.center.x-this.speed,this.facing="left"):this.keyboarder.isDown(this.keyboarder.KEYS.RIGHT)&&e.right&&(t.x=this.center.x+this.speed,this.facing="right"),this.keyboarder.isDownOnce(this.keyboarder.KEYS.SPACE)&&this.game.bodies.push(new Bullet(this)),this.game.Timer.Delta()>50&&(this.center=t,this.game.Timer.Last()),this.game.fogOfWar.Reveal(this.center)},Player.prototype.Collide=function(t){switch(t){case"wall":break;case"exit":break;case"enemy":}};var Wall=function(t,e,i){this.grid={x:e,y:i},this.params=t,this.visited=!1,this.up=!1,this.down=!1,this.left=!1,this.right=!1,this.corners={top:i*t.scale,bottom:i*t.scale+t.scale,left:e*t.scale,right:e*t.scale+t.scale},this.drawn=!1};Wall.prototype=Object.create(GameObject),Wall.prototype.Draw=function(t){this.drawn||(this.visited?(this.up||(t.moveTo(this.corners.left,this.corners.top),t.lineTo(this.corners.right,this.corners.top)),this.down||(t.moveTo(this.corners.left,this.corners.bottom),t.lineTo(this.corners.right,this.corners.bottom)),this.left||(t.moveTo(this.corners.left,this.corners.top),t.lineTo(this.corners.left,this.corners.bottom)),this.right||(t.moveTo(this.corners.right,this.corners.top),t.lineTo(this.corners.right,this.corners.bottom))):t.fillRect(this.corners.left,this.corners.top,10,10),t.stroke(),this.drawn=!0)},Wall.prototype.Clear=function(){};var Level=function(){this.params={width:50,height:50,turn:.2,branch:1,reconnect:0,deadEnd:0,scale:16,enemies:10},this.grid=new HashTable};Level.prototype=Scene,Level.prototype.Start=function(t){t.ClearScreen();var e=new Maze(this.params);e.Build(),e.Draw(t.context,this),t.fogOfWar.Init(),t.bodies.push(new Player(t));for(var i=0;i<this.params.enemies;i++)t.bodies.push(new Enemy(t));t.bodies.push(new Exit(t)),t.Timer.Start()};var MainMenu=function(){};MainMenu.prototype=Scene;var Game=function(t){this.canvas=document.getElementById(t),this.context=this.canvas.getContext("2d"),this.Level=new Level,this.Timer=new Timer,this.fogOfWar=new FogOfWar(this),this.bodies=[];var e=function(){this.Update(),this.Draw(),requestAnimationFrame(e)}.bind(this);e(),this.StartMaze()};Game.prototype.SetupCanvas=function(t){var e=document.getElementById("gameArea"),i=1,s=window.innerWidth,h=window.innerHeight,a=s/h;a>i?(s=h*i,e.style.height=h+"px",e.style.width=s+"px"):(h=s/i,e.style.width=s+"px",e.style.height=h+"px"),e.style.marginTop=-h/2+"px",e.style.marginLeft=-s/2+"px";var o=document.getElementById(t);return o.width=s,o.height=h,o},Game.prototype.Convert={gameXToCanvasX:function(t){return t/game.gameWidth*gameCanvas.width},gameYToCanvasY:function(t){return t/game.gameHeight*gameCanvas.height},canvasXToGameX:function(t){return t*gameCanvas.width/game.gameWidth},canvasYToGameY:function(){return y*gameCanvas.height/game.gameHeight}},Game.prototype.ClearScreen=function(){this.bodies=[],this.context.clearRect(0,0,this.canvas.width,this.canvas.height)},Game.prototype.StartMaze=function(){this.Level.Start(this)},Game.prototype.MainMenu=function(){},Game.prototype.Update=function(){this.fogOfWar.Init(),this.bodies.forEach(function(t){t.Clear(this.context),t.Update()}.bind(this))},Game.prototype.Draw=function(){this.bodies.forEach(function(t){t.Draw(this.context)}.bind(this))},Game.prototype.Win=function(){alert("You Win!")},Game.prototype.Destroy=function(t){this.bodies.splice(this.bodies.indexOf(t),1)};